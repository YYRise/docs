---
title: "TCP IP"
date: 2021-07-01T09:50:24+08:00
draft: false
---

[TCP/IP到底是怎么分片的？](https://mp.weixin.qq.com/s/Z8wzEv16TkrGbQ9ZKX58eA)

## MSS

- Maximum Segment Size
- TCP 提交给 IP 层最大分段大小，不包含 TCP Header 和  TCP Option，只包含 TCP Payload ，MSS 是 TCP 用来限制应用层最大的发送字节数。
- MSS会在三次握手的过程中传递给对方，用于通知对端本地最大可以接收的TCP报文数据大小（不包含TCP和IP报文首部）
- 两者在对比后，会采用小的那个值作为通信的MSS值，这个过程叫MSS协商。
- 如果没有接收到对端TCP的MSS，本端TCP默认采用MSS=536Byte。
- `536（data） + 20（tcp头）+20（ip头）= 576Byte` ，576正好是 IP 最小重组缓冲区的大小。

## MTU
- Maximum Transmit Unit，最大传输单元。
- 由数据链路层提供，一般 MTU=1500 Byte。

## 为什么IP层会分片，TCP还要分段

- 数据在TCP分段，就是为了在IP层不需要分片，同时发生重传的时候只重传分段后的小份数据。 

假设有一份数据，较大，且在TCP层不分段，如果这份数据在发送的过程中出现丢包现象，TCP会发生重传，那么重传的就是这一大份数据（虽然IP层会把数据切分为MTU长度的N多个小包，但是TCP重传的单位却是那一大份数据）。
如果TCP把这份数据，分段为N个小于等于MSS长度的数据包，到了IP层后加上IP头和TCP头，还是小于MTU，那么IP层也不会再进行分包。此时在传输路上发生了丢包，那么TCP重传的时候也只是重传那一小部分的MSS段。效率会比TCP不分段时更高。
UDP本身不会分段，所以当数据量较大时，只能交给IP层去分片，然后传到底层进行发送。

## IP层怎么做到不分片

整个链路上，最小的MTU，就叫PMTU（path MTU）。

![img](/images/Net/TCP-IP/IP报头DF.png)
<center>IP报头DF</center>

- DF（Don't Fragment）

- 如果为0（允许分片），就会分片并把分片后的数据传到下一个路由器

- 如果为1，就会把数据丢弃，同时返回一个ICMP包给发送端，并告诉它"达咩!"数据不可达，需要分片，同时带上当前机器的MTU

### PMTU发现是怎么实现的

- 应用通过TCP正常发送消息，传输层TCP分段后，到网络层加上IP头，DF置为1，消息再到更底层执行发送

- 此时链路上有台路由器由于各种原因MTU变小了

- IP消息到这台路由器了，路由器发现消息长度大于自己的MTU，且消息自带DF不让分片。就把消息丢弃。同时返回一个ICMP错误给发送端，同时带上自己的MTU。

- 发送端收到这个ICMP消息，会更新自己的MTU，同时记录到一个PMTU表中。

- 因为TCP的可靠性，会尝试重传这个消息，同时以这个新MTU值计算出MSS进行分段，此时新的IP包就可以顺利被刚才的路由器转发。

- 如果路径上还有更小的MTU的路由器，那上面发生的事情还会再发生一次